<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aztec Hall — Community Shout‑outs</title>
  <meta name="description" content="Community shout‑outs and roles for the Aztec ecosystem." />
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%236f6ce8"/><rect x="18" y="18" width="28" height="28" rx="6" fill="%23ffffff"/></svg>'>

  <style>
    :root{
      /* Dark theme to match Wall/Meme */
      --bg0:#0b0f16; --bg1:#101628; --ink:#e7eaff; --muted:#97a0c9; --brand:#6f6ce8;
      --card:#121b32; --card2:#0c1429; --ring:#22305d;
      --shadow:0 10px 26px rgba(0,0,0,.35);

      /* Role colors (chips) */
      --role-Homestaker-Sentinel:#a17600;
      --role-High-Attester:#a3e635;
      --role-Proposal-Commander:#214168;
      --role-Meme-Lord:#4000ff;
      --role-Content-Chronicler:#22c55e;
      --role-Queue-Master:#7F00FF;
      --role-The-Paragon:#f472b6;
      --role-The-Archivist:#06b6d4;
      --role-Maestro:#a401b6;
      --role-Explorer:#e40000;
      --role-Initiated:#c084fc;
      --role-Tester:#fb923c;
      --role-Town-Hall-Warrior:#64748b;
      --role-Defender:#003e09;
      --role-Developer:#1d4ed8;

      --role-1:#6d28d9; --role-2:#0891b2; --role-3:#16a34a; --role-4:#f59e0b; --role-5:#ef4444; --role-6:#9333ea;
    }

    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      background:
        radial-gradient(1100px 700px at 0% -20%, #132242 0%, var(--bg0) 45%),
        radial-gradient(900px 600px at 120% 120%, #1a2450 0%, transparent 60%),
        var(--bg0);
    }

    /* Header */
    .bar{position:sticky; top:0; z-index:10; backdrop-filter:blur(6px); background:rgba(11,15,22,.75); border-bottom:1px solid var(--ring)}
    .bar .wrap{display:flex; align-items:center; gap:14px; padding:18px; max-width:1280px; margin:0 auto}
    .brand{width:64px; height:64px; border-radius:12px; display:grid; place-items:center; background:var(--brand); box-shadow:inset 0 0 0 2px #fff3}
    .brand svg{width:70%; height:70%}
    .title{font-weight:900; letter-spacing:.2px; color:#fff; font-size:36px; line-height:1}
    .muted{color:var(--muted); font-size:16px}

    .main{max-width:1280px; margin:0 auto; padding:24px 18px 90px}

    /* Controls */
    .controlsWrap{max-width:940px; margin:0 auto 18px}
    .controls{
      display:grid; grid-template-columns:1fr 220px; gap:12px; align-items:center;
    }
    .field{display:grid; gap:6px; text-align:left}
    label{font-size:13px; color:#b6baf2; font-weight:900; letter-spacing:.2px}
    input[type="search"], select{
      height:48px; padding:0 14px; font-size:15px;
      background:#0f1a39; color:#e9ecff; border:1px solid #1d2952; border-radius:12px; outline:none;
    }
    select{
      -webkit-appearance:none; appearance:none; padding-right:36px;
      background-image:url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M5 7l5 6 5-6' fill='none' stroke='%236f6ce8' stroke-width='2'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 10px center; background-size:16px
    }
    @media (max-width:640px){
      .controls{ grid-template-columns:1fr 1fr }
      input[type="search"], select{ font-size:14px; padding:0 12px }
    }

    /* ===== Ordered Masonry (grid + JS row spans) ===== */
    /* Pinterest-style columns (keeps source order) */
/* Masonry columns (explicit, stable order) */
#cards.cols{ display:flex; gap:14px; align-items:flex-start; }
#cards.cols .col{ flex:1 1 0; display:flex; flex-direction:column; gap:14px; }

/* responsive: choose how many columns in JS; this keeps cards pretty */
@media (max-width:640px){ #cards.cols{ gap:12px; } }
@media (min-width:900px){ .grid{ column-count: 3 } }
@media (min-width:1280px){ .grid{ column-count: 4 } }

/* Cards inside columns */
.card{
  display: inline-block;     /* <-- important for column layout */
  width: 100%;
  margin: 0 0 14px;          /* gap between items vertically */
  background: linear-gradient(180deg,var(--card),var(--card2));
  border:1px solid var(--ring);
  border-radius:16px;
  overflow:hidden;
  box-shadow:var(--shadow);
  transition:transform .16s ease, box-shadow .16s ease;
  break-inside: avoid;       /* prevent split across columns */
}
.card:hover{ transform:translateY(-2px); box-shadow:0 14px 36px rgba(0,0,0,.45) }

    .pfpWrap{ width:100%; background:#0b1124; border-bottom:1px solid var(--ring) }
    .pfp{ width:100%; height:100%; overflow:hidden }
    .pfp img{ width:100%; height:100%; object-fit:cover; display:block; background:#0c1429 }

    .body{ padding:10px 10px 12px; display:flex; flex-direction:column; gap:8px }
    .topRow{display:flex; align-items:center; gap:8px; justify-content:space-between}
    .rank{display:inline-flex; align-items:center; justify-content:center; min-width:32px; height:24px; padding:0 8px; font-weight:900; border-radius:999px; background:#0f1a39; color:#d8ddff; border:1px solid #1d2952; font-size:13px}
    .name{ font-weight:900; font-size:16px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    .rolesWrap{ background:#0f1330; border:1px solid #1c2650; border-radius:12px; padding:8px }
    .roles{ display:flex; gap:6px; flex-wrap:wrap }
    .role{
      font-weight:800; padding:5px 8px; border-radius:999px; font-size:12px;
      border:1px solid #22305d; background:#101632; color:#e7ebff;
      box-shadow: inset 0 -2px 4px rgba(0,0,0,.04)
    }

    .empty{ color:#c8cff9; text-align:center; padding:18px; font-size:.95rem }

    /* Skeletons */
    .skeleton{ border-radius:16px; border:1px solid var(--ring); background:linear-gradient(180deg,var(--card),var(--card2)); box-shadow:var(--shadow); overflow:hidden }
    .sk-img{ height:200px; background:linear-gradient(90deg,#0f1430 25%,#101842 37%,#0f1430 63%); background-size:400% 100%; animation: shimmer 1.2s infinite }
    .sk-body{ padding:12px }
    .sk-line{ height:14px; border-radius:6px; margin:8px 0; background:linear-gradient(90deg,#0f1430 25%,#101842 37%,#0f1430 63%); background-size:400% 100%; animation: shimmer 1.2s infinite }
    @keyframes shimmer { 0%{background-position:100% 0} 100%{background-position:-100% 0} }

    .notice{max-width:1280px; margin:20px auto 80px; padding:0 18px}
    .notice .board{background:linear-gradient(180deg,var(--card),var(--card2)); border:1px solid var(--ring); border-radius:14px; box-shadow:var(--shadow); padding:16px}
    .notice h3{margin:0 0 8px 0; font-size:22px; color:#fff; letter-spacing:.2px; font-weight:900}
    .notice p{margin:6px 0 10px; color:#cfd6ff; font-size:15px; font-weight:600}
    .notice ul{margin:0; padding-left:18px; line-height:1.6; color:#e5e8ff; font-size:15px}

    .credit{
      position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
      background:#101632;color:#cfd6ff;border:1px solid var(--ring);padding:7px 10px;border-radius:999px;
      font-size:12px;font-weight:800;text-decoration:none;box-shadow:var(--shadow)
    }
    .credit a{color:#cfd6ff;text-decoration:none}
  </style>
</head>
<body>
  <header class="bar">
    <div class="wrap">
      <div class="brand" title="Aztec">
        <svg viewBox="0 0 100 100" fill="none" aria-hidden="true">
          <rect width="100" height="100" rx="22" fill="#ffffff25"/>
          <rect x="20" y="20" width="60" height="60" rx="12" fill="#6f6ce8"/>
          <rect x="35" y="35" width="30" height="30" rx="8" fill="#ffffff"/>
        </svg>
      </div>
      <div>
        <div class="title">Aztec Hall</div>
        <div class="muted">Community shout‑outs and roles</div>
      </div>
      <div style="flex:1"></div>
    </div>
  </header>

  <section class="notice">
    <div class="board">
      <h3>Notice board</h3>
      <p style="color:#ffd083; font-weight:700">The table is updated weekly after Community TownHall.</p>
      <p><strong>To be listed here, you must have at least one of these roles:</strong></p>
      <ul>
        <li>Homestaker Sentinel</li>
        <li>High Attester</li>
        <li>Proposer commander</li>
        <li>Content chronicler</li>
        <li>Queue Master</li>
        <li>Maestro</li>
        <li>The Paragon</li>
        <li>The Archivist</li>
      </ul>
    </div>
  </section>

  <main class="main">
    <section class="controlsWrap">
      <div class="controls">
        <div class="field">
          <label for="q">Search</label>
          <input id="q" type="search" placeholder="Search name or handle…" />
        </div>
        <div class="field">
          <label for="roleSel">Filter by role</label>
          <select id="roleSel"><option value="">All roles</option></select>
        </div>
      </div>
    </section>

    <section id="cards" class="grid" aria-live="polite"></section>
  </main>

  <a class="credit" href="https://x.com/seuncoded" target="_blank" rel="noopener">Built by @seuncoded</a>

  <script>
    /* ============ Data & State ============ */

    // Must have at least one of these roles:
    const REQUIRED_ROLES = new Set([
      'Homestaker Sentinel','High Attester','Proposer commander','Content Chronicler',
      'Queue Master','Maestro','The Paragon','The Archivist'
    ]);

    const SHEET_JSON_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhUaagfckU5EY06gOWlMtrOxN0YE9i5UR9cLCrdFD0CFmhI7hmMKaw9liDmiWCYXZRLaI4J-WNcinmeMqb0b-61ti2FFT2D4SKbKLhfgeOhstt1cmI4qncEVq9XUgJihONg6PPZUht3Nuy25j_ln4PbdaY5c8-sqW7X5S0fauIfcpxou13f-XjT_etQcY2UvZMxq5mRnRhSRJJFtfdjcXSYYFbKNXxbAPBOFCPy-ZcMJJu-0icqWOCsO_kwOnCfr8SXm5L5y2w4o__wIZdX6vAFmfDLPHDc6qM3c5N5&lib=MmoffGhvRFJSfNRmoE_Umb04A79LrDTNZ";
    const API_URL = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? SHEET_JSON_URL : "/api/contributors";

    const el = s => document.querySelector(s);
    const state = { all:[], filtered:[], search:'', role:'' };

    /* ============ Load & Normalize ============ */

    async function loadData(){
      const res = await fetch(API_URL, { cache:'no-store' });
      if(!res.ok) throw new Error('Failed to load /api/contributors');
      const raw = await res.json();
      return (Array.isArray(raw)?raw:[]).map(item=>{
        const roles = Array.isArray(item.roles)
          ? item.roles
          : String(item.roles||'').split('|').map(s=>s.trim()).filter(Boolean);
        return {
          id:item.id||'', name:item.name||'', handle:item.handle||'',
          twitterUrl:item.twitterUrl||'', pfp:item.pfp||item.localPfp||'', roles
        };
      });
    }

    /* ============ Sorting & Filtering ============ */

    const css = getComputedStyle(document.documentElement);
    const colorMap = new Map([
      ['Homestaker Sentinel', css.getPropertyValue('--role-Homestaker-Sentinel')],
      ['High Attester', css.getPropertyValue('--role-High-Attester')],
      ['Proposal Commander', css.getPropertyValue('--role-Proposal-Commander')],
      ['Proposer commander', css.getPropertyValue('--role-Proposal-Commander')],
      ['Meme Lord', css.getPropertyValue('--role-Meme-Lord')],
      ['Content Chronicler', css.getPropertyValue('--role-Content-Chronicler')],
      ['Content chronicler', css.getPropertyValue('--role-Content-Chronicler')],
      ['Queue Master', css.getPropertyValue('--role-Queue-Master')],
      ['The Paragon', css.getPropertyValue('--role-The-Paragon')],
      ['The Archivist', css.getPropertyValue('--role-The-Archivist')],
      ['Maestro', css.getPropertyValue('--role-Maestro')],
      ['Explorer', css.getPropertyValue('--role-Explorer')],
      ['Initiated', css.getPropertyValue('--role-Initiated')],
      ['Tester', css.getPropertyValue('--role-Tester')],
      ['Tester Role', css.getPropertyValue('--role-Tester')],
      ['Town Hall Warrior', css.getPropertyValue('--role-Town-Hall-Warrior')],
      ['Town hall Warrior', css.getPropertyValue('--role-Town-Hall-Warrior')],
      ['Defender', css.getPropertyValue('--role-Defender')],
      ['Developer', css.getPropertyValue('--role-Developer')],
    ]);
    const fallback = ['--role-1','--role-2','--role-3','--role-4','--role-5','--role-6'].map(v=>css.getPropertyValue(v));

    function pill(role,i){
      const col = (colorMap.get(role) || fallback[i%fallback.length]).trim() || '#6f6ce8';
      const style = `background:${col}22; border-color:${col}90; color:#e8ebff;`;
      return `<span class="role" style="${style}">${escapeHtml(role)}</span>`;
    }

    function applyFiltersAndRank(){
      const q = state.search.toLowerCase();
      let arr = state.all.map(p => ({ ...p, roles:(p.roles||[]) }));

      // must have at least one required role
      arr = arr.filter(p => (p.roles||[]).some(r => REQUIRED_ROLES.has(r)));

      if(q){
        arr = arr.filter(x =>
          (x.name||'').toLowerCase().includes(q) ||
          (x.handle||'').toLowerCase().includes(q)
        );
      }
      if(state.role){
        arr = arr.filter(x => (x.roles||[]).includes(state.role));
      }

      // Sort: by #roles desc, then by name
      arr.sort((a,b)=>{
        const da=(a.roles||[]).length, db=(b.roles||[]).length;
        return db - da || (a.name||'').localeCompare(b.name||'');
      });

      // Assign stable ranking 1..N
      arr.forEach((p, idx) => {
        p.rank = idx + 1;
        p.roleCount = (p.roles||[]).length;
      });

      state.filtered = arr;
    }

    /* ============ HTML Builders ============ */

    function avatarHtml(p){
      if (p.pfp){
        return `<div class="pfp"><img src="${p.pfp}" alt="${escapeHtml(p.name||'')}" loading="lazy" decoding="async"></div>`;
      }
      const letter = (p.name||'?').slice(0,1).toUpperCase();
      return `<div class="pfp" style="display:grid;place-items:center;background:#0f1a39;color:#6f6ce8;font-weight:900;font-size:42px">${letter}</div>`;
    }

    function cardHtml(p){
      const roles = (p.roles||[]).map((r,i)=> pill(r,i)).join('');
      const hrefAttr = p.twitterUrl ? ` data-href="${p.twitterUrl}"` : '';
      return `
        <article class="card"${hrefAttr} data-id="${escapeHtml(p.id)}">
          <div class="pfpWrap">${avatarHtml(p)}</div>
          <div class="body">
            <div class="topRow">
              <div class="name">${escapeHtml(p.name||'')}</div>
              <span class="rank">#${p.rank}</span>
            </div>
            <div class="rolesWrap"><div class="roles">${roles}</div></div>
          </div>
        </article>`;
    }

    /* ============ Ordered Masonry Helpers ============ */

    /* ============ Render & Interactions ============ */

    function renderSkeletons(n=8){
      const card = () => `
        <div class="skeleton">
          <div class="sk-img"></div>
          <div class="sk-body">
            <div class="sk-line" style="width:70%"></div>
            <div class="sk-line" style="width:40%"></div>
            <div class="sk-line" style="width:90%"></div>
          </div>
        </div>`;
      el('#cards').innerHTML = Array.from({length:n}, card).join('');
    }

    function rebuildRoleFilterFromVisible(){
      const roleSel = document.querySelector('#roleSel');
      const prev = roleSel.value;
      const visibleRoles = Array.from(new Set(state.filtered.flatMap(x => x.roles || []))).sort((a,b)=>a.localeCompare(b));
      roleSel.innerHTML = '<option value="">All roles</option>' + visibleRoles.map(r=>`<option value="${r}">${r}</option>`).join('');
      if (prev && visibleRoles.includes(prev)) roleSel.value = prev; else state.role = '';
    }

    function getColCount(){
  const w = window.innerWidth;
  if (w < 640) return 1;
  if (w < 960) return 2;
  if (w < 1280) return 3;
  return 4;
}

function render(){
  applyFiltersAndRank();           // you already sort by role count desc + tie by name
  const wrap = document.getElementById('cards');

  if (!state.filtered.length){
    wrap.className = '';           // not using columns for the empty state
    wrap.innerHTML = `<div class="empty">No matches. Try clearing filters.</div>`;
    rebuildRoleFilterFromVisible();
    return;
  }

  const cols = getColCount();
  wrap.className = 'cols';         // <- use the new columns style
  wrap.innerHTML = '';             // clear

  // create N columns
  const colEls = Array.from({length: cols}, () => {
    const c = document.createElement('div');
    c.className = 'col';
    wrap.appendChild(c);
    return c;
  });

  // place cards round‑robin to preserve left→right visual order
  state.filtered.forEach((p, i) => {
    const html = cardHtml(p);                      // your existing card renderer
    const el = document.createElement('div');
    el.innerHTML = html;
    colEls[i % cols].appendChild(el.firstElementChild);
  });

  rebuildRoleFilterFromVisible();
}

// keep the layout responsive when resizing
let _rt;
window.addEventListener('resize', () => {
  clearTimeout(_rt);
  _rt = setTimeout(render, 120);
});

    // click card -> open Twitter
    document.addEventListener('click', (e)=>{
      const card = e.target.closest('.card[data-href]');
      if(!card) return;
      const url = card.getAttribute('data-href');
      if(url) window.open(url, '_blank', 'noopener');
    });

    function escapeHtml(s){ return String(s).replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }

    // Bind controls
    el('#q').addEventListener('input', (e)=>{ state.search = e.target.value; render(); });
    document.querySelector('#roleSel').addEventListener('change', (e)=>{ state.role = e.target.value; render(); });

    // Init
    (async function init(){
      renderSkeletons(8);
      try{
        state.all = await loadData();
        render();
      }catch(e){
        el('#cards').innerHTML = `<div class="empty">Failed to load. Refresh to try again.</div>`;
      }
    })();
  </script>
</body>
</html>